---
title: 文件上传漏洞
date: 2021-02-20 21:11:55
tags:
	- 渗透
	- 安全
typora-root-url: ./
---

# 文件上传漏洞

## 造成文件上传漏洞的原因是

1、对于上传文件的后缀名（扩展名）没有做较为严格的限制

2、对于上传文件的MIMETYPE 没有做检查

3、权限上没有对于上传的文件的文件权限，（尤其是对于shebang类型的文件）

4、对于web server对于上传文件或者指定目录的行为没有做限制

## 漏洞上传方法：

IIS6.0 的解析漏洞 ：1.jpg%00.php 1.asp;.jpg 1.asp/1.jpg

IIS 7.0/IIS 7.5/ Nginx <8.03 畸形解析 1.jpg/.php

Nginx <8.03 空字节代码执行漏洞 1.jpg%00.php

Apache 解析漏洞 .php.一个无效后缀

还有就是 Windows 下的各种截断了，因为 win 环境下不允许一些符号命名文件，所以可以造成截断文件名的效果，不过恕我直言，用 Windows 当服务器就是 sb...

### 1、前端绕过，上传可上传文件后，截包修改后缀

### 2、在一些 webserver 中，存在解析漏洞

1）老版本的IIS中的目录解析漏洞，如果网站目录中有一个 /.asp/目录，那么此目录下面的一切内容都会被当作asp脚本来解析

2）老板本的IIS中的分号漏洞：IIS在解析文件名的时候可能将分号后面的内容丢弃，那么我们可以在上传的时候给后面加入分号内容来避免黑名单过滤，如 a.asp;jpg

3）旧版Windows Server中存在空格和dot漏洞类似于 a.php. 和 a.php[空格] 这样的文件名存储后会被windows去掉点和空格，从而使得加上这两个东西可以突破过滤，成功上传，并且被当作php代码来执行

4）nginx空字节漏洞 xxx.jpg%00.php 这样的文件名会被解析为php代码运行

5）apache的解析漏洞，上传如a.php.rar a.php.gif 类型的文件名，可以避免对于php文件的过滤机制，但是由于apache在解析文件名的时候是从右向左读，如果遇到不能识别的扩展名则跳过，rar等扩展名是apache不能识别的，因此就会直接将类型识别为php，从而达到了注入php代码的目的

### 3、检查HTTP Header中的Content-Type

使用各种各样的工具（如burpsuite）强行篡改Header就可以，太容易将header中的

Content-Type: application/php

或者其他类型

Content-Type: image/jpg

Content-Type: image/png

Content-Type: text/plain

等这些web程序允许的泪洗改附上常用的MIMETYPE表

text/plain（纯文本）

text/html（HTML文档）

text/javascript（js代码）

application/xhtml+xml（XHTML文档）

image/gif（GIF图像）

image/jpeg（JPEG图像）

image/png（PNG图像）

video/mpeg（MPEG动画）

application/octet-stream（二进制数据）

application/pdf（PDF文档）

application/(编程语言) 该种语言的代码

application/msword（Microsoft Word文件）

message/rfc822（RFC 822形式）

multipart/alternative（HTML邮件的HTML形式和纯文本形式，相同内容使用不同形式表示）

application/x-www-form-urlencoded（POST方法提交的表单）

multipart/form-data（POST提交时伴随文件上传的表单）

### 4、图片文件通常有称作幻数的头字节，我们来看一下几种图片文件的幻数：

（注意！下面是二进制而不是文本格式的数据）

JPG

FF D8 FF E0 00 10 4A 46 49 46

GIF

47 49 46 38 39 61

(相当于文本的GIF89a)

PNG

89 50 4E 47

通过检查头几位字节，可以分辨是否是图片文件

如果是其他类型的二进制文件，也有响应的头字节，如下表

反制

给上传脚本加上相应的幻数头字节就可以，php引擎会将 <?之前的内容当作html文本，不解释而跳过之，后面的代码仍然能够得到执行比如下面：

（一般不限制图片文件格式的时候使用GIF的头比较方便，因为全都是文本可打印字符。）

GIF89a

<?php

do_something();

?>

如果是其他类型的二进制文件，也有响应的头字节，如下表

| 格式                       | 文件头               |
| -------------------------- | -------------------- |
| TIFF (tif)                 | 49492A00             |
| Windows Bitmap (bmp)       | 424D                 |
| CAD (dwg)                  | 41433130             |
| Adobe Photoshop (psd)      | 38425053             |
| Rich Text Format (rtf)     | 7B5C727466           |
| MS Word/Excel (xls.or.doc) | D0CF11E0             |
| MS Access (mdb)            | 5374616E64617264204A |
| ZIP Archive (zip)，        | 504B0304             |
| RAR Archive (rar)，        | 52617221             |
| Wave (wav)，               | 57415645             |
| AVI (avi)，                | 41564920             |
| Real Media (rm)，          | 2E524D46             |
| MPEG (mpg)，               | 000001BA             |
| MPEG (mpg)，               | 000001B3             |
| Quicktime (mov)，          | 6D6F6F76             |
| Adobe Acrobat (pdf)，      | 255044462D312E       |
| Windows Media (asf)，      | 3026B2758E66CF11     |
| MIDI (mid)，               | 4D546864             |

### 5.限制Web Server对于特定类型文件的行为

通过 move_uploaded_file 函数把自己写的.htaccess 文件上传，覆盖掉服务器上的文件，来定义文件类型和执行权限如果做到了这一点，将获得相当大的权限。

## 一句话木马上传常见的几种方法

1，利用00截断，brupsuite上传

利用00截断就是利用程序员在写程序时对文件的上传路径过滤不严格，产生0X00上传截断漏洞。 

假设文件的上传路径为http://xx.xx.xx.xx/upfiles/lubr.php.jpg ,通过Burpsuite抓包截断将lubr.php后面的“.”换成“0X00”。在上传的时候，当文件系统读到”0X00″时，会认为文件已经结束，从而将lubr.php.jpg 的内容写到lubr.php中，从而达到攻击的目的。

2，构造服务器端扩展名检测上传

当浏览器将文件提交到服务器端的时候，服务器端会根据设定的黑名单对浏览器提交上来的文件扩展名进行检测，如果上传的文件扩展名不符合黑名单的限制，则不予上传，否则上传成功。 

本例讲解，将一句话木马的文件名lubr.php改成lubr.php.abc。首先，服务器验证文件扩展名的时候，验证的是.abc，只要改扩展名符合服务器端黑名单规则，即可上传。另外，当在浏览器端访问该文件时，Apache如果解析不了.abc扩展名，会向前寻找可解析的扩展名，即”.php”。一句话木马可以被解析，即可通过中国菜刀连接。

3，绕过Content-Type检测文件类型上传

当浏览器在上传文件到服务器端的时候，服务器对上传的文件Content-Type类型进行检测，如果是白名单允许的，则可以正常上传，否则上传失效。绕过Content-Type文件类型检测，就是用Burpsuite截取并修改数据包中文件的Content-Type类型，使其符合白名单的规则，达到上传的目的。

4，构造图片木马，绕过文件内容检测上传Shell

一般文件内容验证使用getimeagesize()函数检测，会判断文件是否一个有效的文件图片，如果是，则允许上传，否则的话不允许上传。

制作图片木马： copy 1.jpg/b+2.php/a 3.jpg



## pikaqiu靶机上传漏洞

1、客户端check：仅做了前台校验

方法：

1）上传PHP修改过后缀的文件（phpinfo.php 1.jpg），burp截包，修改文件名为：phpinfo.php，修改成功

2）修改hex中phpinfo.php 1.jpg中的值，将空格（20）修改为（00），进行截断，上传成功

2、服务端check（仅MIME type校验）

方法：

1）同问题1解决方法

2）由于前台无校验，直接上传php文件（phpinfo.php），burp截包，修改Content-Type类型为Content-Type: image/jpeg，上传成功

3、getimagesize()

方法：初步估计，采用制作木马图片